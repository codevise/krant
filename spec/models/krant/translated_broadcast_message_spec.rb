require 'rails_helper'

module Krant
  RSpec.describe TranslatedBroadcastMessage, type: :model do
    describe '.active' do
      it 'returns active translated broadcast message in default locale' do
        create(:broadcast_message, :active,
               text_translations: {
                 de: 'Wichtige Nachricht',
                 en: 'Important message'
               })

        texts = TranslatedBroadcastMessage.active.map(&:text)

        expect(texts).to include('Important message')
      end

      it 'returns active translated broadcast message in current locale' do
        create(:broadcast_message, :active,
               text_translations: {
                 en: 'Important message',
                 de: 'Wichtige Nachricht'
               })

        texts = I18n.with_locale(:de) do
          TranslatedBroadcastMessage.active.map(&:text)
        end

        expect(texts).to include('Wichtige Nachricht')
      end

      it 'falls back to default locale if translation is missing' do
        create(:broadcast_message, :active,
               text_translations: {
                 en: 'Important message'
               })

        texts = I18n.with_locale(:de) do
          TranslatedBroadcastMessage.active.map(&:text)
        end

        expect(texts).to include('Important message')
      end

      it 'falls back to default locale if translation has blank text' do
        create(:broadcast_message, :active,
               text_translations: {
                 de: ' ',
                 en: 'Important message'
               })

        texts = I18n.with_locale(:de) do
          TranslatedBroadcastMessage.active.map(&:text)
        end

        expect(texts).to include('Important message')
      end

      it 'does not include inactive broadcast messages' do
        create(:broadcast_message,
               text_translations: {
                 de: 'Wichtige Nachricht',
                 en: 'Important message'
               })

        expect(TranslatedBroadcastMessage.active).to be_empty
      end

      it 'allows filtering by location' do
        create(:broadcast_message,
               :active,
               text_translations: {
                 de: 'Wichtige Nachricht',
                 en: 'Important message'
               })
        create(:broadcast_message,
               :active,
               location: 'custom',
               text_translations: {
                 de: 'Andere Nachricht',
                 en: 'Other message'
               })

        texts = TranslatedBroadcastMessage.active(location: 'custom').map(&:text)

        expect(texts).to eq(['Other message'])
      end

      it 'filters messages with custom location by default' do
        create(:broadcast_message,
               :active,
               text_translations: {
                 de: 'Wichtige Nachricht',
                 en: 'Important message'
               })
        create(:broadcast_message,
               :active,
               location: 'custom',
               text_translations: {
                 de: 'Andere Nachricht',
                 en: 'Other message'
               })

        texts = TranslatedBroadcastMessage.active.map(&:text)

        expect(texts).to eq(['Important message'])
      end
    end
  end
end
